# Contextualization Guide for Graph Neural Networks (GNN) in Business Survival Models

## 1. Project Context (Status Quo)

### 1.1. Title and Author
*   **Title:** Effects of Business Formalization on the Sustainability of Peruvian MSMEs in 2022 (Efectos de la Formalización Empresarial sobre la Sostenibilidad de las MYPES Peruanas en 2022).
*   **Main Author/Investigator:** Leonardo Abel León Pérez.

### 1.2. Original Objective
To analyze the impact of formalization (holding a RUC) on the probability of business survival (active in 2021) for Peruvian MSMEs, examining regional heterogeneity.

### 1.3. Current Data and Methodology (Logit)
*   **Data Source:** V National Economic Census 2022 (INEI), corresponding to the 2021 fiscal year.
*   **Sample Size:** 1,327,956 MSMEs.
*   **Econometric Model:** Logistic Regression (Logit) with cluster-robust standard errors by 4-digit CIIU code.
*   **Key Variables:** `Survival` (Dependent), `RUC` (Main Independent), `Net Sales`, `Productivity`, `Tax Regime` (`Régimen Tributario`), `Region` (Coast/Sierra/Selva), and interaction terms (`RUC × Region`).
*   **Data Preprocessing Status:** Stata script (`limpieza.do`) now generates a GNN-ready dataset (`msme_gnn_preprocessed.dta`) containing:
    *   **UBIGEO** (6-digit): `CCDD` + `CCPP` + `CCDI` for precise District location.
    *   **CIIU 4-digit**: For sectoral competition edges.
    *   **CIIU 2-digit**: For broad sector features.

### 1.4. Critical Findings from the Logit Model
1.  **Counter-Intuitive Effect:** Formalization **reduces** the probability of survival in the **Coast** (-5.09 pp) and **Selva** (-5.41 pp), contradicting the initial hypothesis.
2.  **Heterogeneous Effect (Geographic Location):** The effect is neutral or slightly positive in the **Sierra** (+1.08 pp), confirming regional heterogeneity.
3.  **Methodological Limitation:** The primary constraint is the **cross-sectional analysis** and the approximation of neighborhood/competition effects using macro-region *dummies*.

---

## 2. Vision and Rationale for Advancing to GNN

### 2.1. New Objective (GNN)
To refine the business survival econometric calculations by explicitly modeling **network interactions (competition and agglomeration)** between MSMEs, replacing the regional variable approximation with a granular graph structure.

### 2.2. Rationale (Extended Framework)
*   **GNN in Presentation:** The slide deck (*NVIDIA intro_to_gnn.pptx*) confirms that GNNs are suitable for **Node-Level Classification** (which is the binary survival task: 0=No, 1=Yes).
*   **GNN in Economics:** GNNs allow for modeling **Industrial Organization** and **Spatial Distribution** phenomena by capturing spillover or local competition effects.
*   **Inductive Learning (GraphSAGE):** We adopt an **Inductive** approach (Hamilton et al., 2017) to learn *aggregator functions* rather than fixed node embeddings. This allows predicting survival for *new enterprises* entering the market, a critical capabilities for dynamic economic analysis.

---

## 3. Data Mapping to Graph Structure

The clean database (`msme_gnn_preprocessed.dta`) will be converted into a PyG `HeteroData` object:

| Graph Component | Variable Source | Description |
|-----------------|-----------------|-------------|
| **Nodes**       | Rows in `.dta` | 1,327,956 MSMEs. |
| **Features (X)**| `ventas_uit`, `productividad`, `regimen`, `ciiu_2dig`, `digital_score` | Normalized numeric features + One-hot encoded categorical features. |
| **Label (Y)**   | `op2021_ajustado` | Binary survival variable (0/1). |
| **Edges**       | **Geo + Sector** | **Edge A (Agglomeration)**: Undirected edge if `ubigeo_i == ubigeo_j` (Same District).<br>**Edge B (Competition)**: Undirected edge if `ciiu_4dig_i == ciiu_4dig_j` (Same specific industry). |


---

## 4. Challenges and Advanced Insight Objectives

The GNN model will be trained to minimize the classification loss for the `op2021_original` variable. The advanced insights to be extracted are:

| Advanced Insight | Justification for Analysis |
| **Granular Neighborhood Effects** | Measure the impact of RUC on survival, conditioned by the **average Productivity** or **Tax Regime distribution** of MSMEs in the same district/sector. This will validate or reject the "signaling effect" mechanism at a micro-level, refining the analysis of **Geographic Location** and **Productivity** beyond the macro-region level. |
| **Methodological Clustering** | Apply a clustering algorithm (e.g., K-means) directly to the **Latent Embeddings** generated by the GNN. This will reveal endogenous business environments (clusters) that are methodologically similar in their network/survival dynamics, going beyond administrative classifications (Coast/Sierra/Selva). |
| **Edge Sensitivity Analysis** | Explore which type of edge (geographic vs. sectoral) is more determinant for survival, identifying whether agglomeration (district) or competition (CIIU) dominates the survival dynamic, thus providing deeper insight into the impact of **Geographic Location**. |

---

## 5. Data Imbalance and Normalization Considerations

### 5.1. Imbalanced Distribution by Firm Size

The database presents a highly imbalanced distribution by firm size:

| Firm Type | Approximate Proportion | Implication |
|-----------|------------------------|-------------|
| **Micro-enterprises** | ~90%+ | Dominate the dataset |
| **Small enterprises** | ~8% | Underrepresented |
| **Medium enterprises** | ~2% | Marginally represented |

**Critical Verification Finding (16/01/2026):**
The dataset contains **1,377,931 MSMEs**, with a survival rate of **96.2%** vs. **3.8%** closed.
- **Action Item**: We MUST use **Class Weights** (Section 5.5) or focal loss during training. Without this, the model will trivially predict "Survived" for every node and achieve high accuracy but 0.0 F1-score for the minority class (closure prediction).

## 6. Project Directory and Workflow Standard

All Python scripts related to GNN data treatment and modeling must be stored in:
`Entrega 6 (paper GNN)/code/`

**Naming Convention**: All scripts must be enumerated to represent the sequential workflow:
1. `1_build_msme_graph.py`: Convert Stata DTA to PyG HeteroData.
2. `2_visualize_clusters.py`: Generate heatmaps.
3. `3_train_gnn.py`: Training pipeline.
(Exception: `limpieza.do` remains in `database/` as the initial Stata cleaning step).

### 5.2. Symmetric Normalization (Kipf & Welling)

To prevent nodes with **many neighbors from dominating** message aggregation (typical in densely populated districts or sectors with high micro-enterprise concentration), the **symmetric normalization** proposed by Kipf & Welling (2017) must be applied:

$$
\hat{A} = D^{-1/2} A D^{-1/2}
$$

Where:
- $A$ is the adjacency matrix
- $D$ is the diagonal degree matrix ($D_{ii} = \sum_j A_{ij}$)
- $D^{-1/2}$ has $1/\sqrt{deg(i)}$ on the diagonal

**Intuitive Interpretation:**
- The message node $j$ sends to node $i$ is divided by $\sqrt{deg(i) \cdot deg(j)}$
- This **balances the contribution** of each neighbor according to the size of their neighborhoods
- Prevents nodes with many neighbors (micro-enterprises in saturated sectors) from dominating the signal

### 5.3. Benefits for the Survival Model

1. **Numerical Stability:** Features maintain a stable scale layer by layer, allowing for stacking more layers without gradient explosion/dilution.

2. **Balanced Representations:** Small and medium enterprises receive equally weighted representations, avoiding bias towards micro-enterprises.

3. **Better Generalization:** In the original Kipf & Welling paper, symmetric normalization reports better results in node classification benchmarks vs. unnormalized or naive mean-pooling.

### 5.4. Implementation in PyTorch Geometric

PyG automatically applies this normalization in `GCNConv`:

```python
from torch_geometric.nn import GCNConv

# GCNConv already includes symmetric normalization by default
conv = GCNConv(in_channels, out_channels)

# For manual control, use the normalize parameter:
conv = GCNConv(in_channels, out_channels, normalize=True)  # Default
```

### 5.5. Additional Considerations for Class Imbalance

In addition to neighborhood normalization, applying **class weighting** in the loss function is recommended for the survival variable imbalance:

```python
# Calculate weights inversely proportional to class frequency
class_counts = torch.bincount(labels)
class_weights = 1.0 / class_counts.float()
class_weights = class_weights / class_weights.sum()  # Normalize

# Apply in Cross Entropy
loss = F.cross_entropy(predictions, labels, weight=class_weights)
```

| Technique | Problem Solved |
|-----------|----------------|
| **Kipf & Welling Normalization** | Imbalance in *graph structure* (nodes with many neighbors) |
| **Class Weighting** | Imbalance in *labels* (more surviving firms vs. non-surviving) |
| **Stratified Sampling** | Imbalance in *batches* during mini-batch training |