# Contextualization Guide for Graph Neural Networks (GNN) in Business Survival Models

## 1. Project Context (Status Quo)

### 1.1. Title and Author
*   **Title:** Effects of Business Formalization on the Sustainability of Peruvian MSMEs in 2022 (Efectos de la Formalización Empresarial sobre la Sostenibilidad de las MYPES Peruanas en 2022).
*   **Main Author/Investigator:** Leonardo Abel León Pérez.

### 1.2. Original Objective
To analyze the impact of formalization (holding a RUC) on the probability of business survival (active in 2021) for Peruvian MSMEs, examining regional heterogeneity.

### 1.3. Current Data and Methodology (Logit)
*   **Data Source:** V National Economic Census 2022 (INEI), corresponding to the 2021 fiscal year.
*   **Sample Size:** 1,327,956 MSMEs.
*   **Econometric Model:** Logistic Regression (Logit) with cluster-robust standard errors by 4-digit CIIU code.
*   **Key Variables:** `Survival` (Dependent), `RUC` (Main Independent), `Net Sales`, `Productivity`, `Tax Regime` (`Régimen Tributario`), `Region` (Coast/Sierra/Selva), and interaction terms (`RUC × Region`).

### 1.4. Critical Findings from the Logit Model
1.  **Counter-Intuitive Effect:** Formalization **reduces** the probability of survival in the **Coast** (-5.09 pp) and **Selva** (-5.41 pp), contradicting the initial hypothesis.
2.  **Heterogeneous Effect (Geographic Location):** The effect is neutral or slightly positive in the **Sierra** (+1.08 pp), confirming regional heterogeneity.
3.  **Methodological Limitation:** The primary constraint is the **cross-sectional analysis** and the approximation of neighborhood/competition effects using macro-region *dummies*.

---

## 2. Vision and Rationale for Advancing to GNN

### 2.1. New Objective (GNN)
To refine the business survival econometric calculations by explicitly modeling **network interactions (competition and agglomeration)** between MSMEs, replacing the regional variable approximation with a granular graph structure.

### 2.2. Rationale (Extended Framework)
*   **GNN in Presentation:** The slide deck (*NVIDIA intro_to_gnn.pptx*) confirms that GNNs are suitable for **Node-Level Classification** (which is the binary survival task: 0=No, 1=Yes).
*   **GNN in Economics:** GNNs allow for modeling **Industrial Organization** and **Spatial Distribution** phenomena by capturing spillover or local competition effects, which form the basis of the heterogeneity findings in the thesis.
*   **Mechanism:** The GNN's **"Message Passing"** process mimics the effect of geographic and sectoral *clustering*. The survival probability of an enterprise (node) will depend not only on its individual attributes (like **Productivity** and **Tax Regime**) but also on the aggregated attributes of its neighbors in the network (other MSMEs in its district/sector).

---

## 3. Data Mapping to Graph Structure

The original database (executed with the `Código de Stata` script) must be converted into a **Graph Object** (`torch_geometric.Data` or similar) with the following structure:

| Graph Component | Original Variable/Data | Description |
| **Nodes**       | Each observation (MSME) | A total of 1,327,956 nodes. |
| **Features (X)**| `ventas_k`, `productividad_k`, `i.regimen`, `i.sector`, `tributos_k`, etc. | The explanatory variables from the Logit model. They must be standardized or normalized for Deep Learning. **(Note: Productivity and Tax Regime are key features).** |
| **Label (Y)**   | `op2021_original`      | The binary survival variable (0/1). **Task:** Node-Level Classification. |
| **Edges**       | **CRITICAL: Province, District, CIIU_4DIG** | Edges must be created between nodes to model the interaction/competition network: **Edge A (Geographic Location):** Sharing the same **District** (finest spatial granularity available). **Edge B (Sectoral):** Sharing the same **4-digit CIIU code** (sectoral competition). |

---

## 4. Challenges and Advanced Insight Objectives

The GNN model will be trained to minimize the classification loss for the `op2021_original` variable. The advanced insights to be extracted are:

| Advanced Insight | Justification for Analysis |
| **Granular Neighborhood Effects** | Measure the impact of RUC on survival, conditioned by the **average Productivity** or **Tax Regime distribution** of MSMEs in the same district/sector. This will validate or reject the "signaling effect" mechanism at a micro-level, refining the analysis of **Geographic Location** and **Productivity** beyond the macro-region level. |
| **Methodological Clustering** | Apply a clustering algorithm (e.g., K-means) directly to the **Latent Embeddings** generated by the GNN. This will reveal endogenous business environments (clusters) that are methodologically similar in their network/survival dynamics, going beyond administrative classifications (Coast/Sierra/Selva). |
| **Edge Sensitivity Analysis** | Explore which type of edge (geographic vs. sectoral) is more determinant for survival, identifying whether agglomeration (district) or competition (CIIU) dominates the survival dynamic, thus providing deeper insight into the impact of **Geographic Location**. |

---

## 5. Consideraciones sobre Desbalance de Datos y Normalización

### 5.1. Distribución Desbalanceada por Tamaño de Empresa

La base de datos presenta una distribución altamente desbalanceada según el tamaño empresarial:

| Tipo de Empresa | Proporción Aproximada | Implicancia |
|-----------------|----------------------|-------------|
| **Microempresas** | ~90%+ | Dominan el dataset |
| **Pequeñas empresas** | ~8% | Subrepresentadas |
| **Medianas empresas** | ~2% | Marginalmente representadas |

**Problema:** Sin corrección, el modelo GNN podría sesgarse hacia patrones de las microempresas, subestimando la dinámica de supervivencia de las pequeñas y medianas empresas.

### 5.2. Normalización Simétrica de Kipf & Welling

Para evitar que los nodos con **muchos vecinos dominen** la agregación de mensajes (típico en distritos densamente poblados o sectores con alta concentración de microempresas), se debe aplicar la **normalización simétrica** propuesta por Kipf & Welling (2017):

$$
\hat{A} = D^{-1/2} A D^{-1/2}
$$

Donde:
- $A$ es la matriz de adyacencia
- $D$ es la matriz diagonal de grados ($D_{ii} = \sum_j A_{ij}$)
- $D^{-1/2}$ tiene $1/\sqrt{deg(i)}$ en la diagonal

**Interpretación Intuitiva:**
- El mensaje que el nodo $j$ envía al nodo $i$ se divide por $\sqrt{deg(i) \cdot deg(j)}$
- Esto **equilibra la contribución** de cada vecino según el tamaño de sus vecindarios
- Evita que nodos con muchos vecinos (microempresas en sectores saturados) dominen la señal

### 5.3. Beneficios para el Modelo de Supervivencia

1. **Estabilidad Numérica:** Las features mantienen escala estable capa a capa, permitiendo apilar más capas sin explosión/dilución de gradientes.

2. **Representaciones Equilibradas:** Empresas pequeñas y medianas reciben representaciones igualmente ponderadas, evitando el sesgo hacia microempresas.

3. **Mejor Generalización:** En el paper original de Kipf & Welling, la normalización simétrica reporta mejores resultados en benchmarks de clasificación de nodos vs. sin normalizar o con mean-pooling ingenuo.

### 5.4. Implementación en PyTorch Geometric

PyG aplica automáticamente esta normalización en `GCNConv`:

```python
from torch_geometric.nn import GCNConv

# GCNConv ya incluye normalización simétrica por defecto
conv = GCNConv(in_channels, out_channels)

# Para control manual, usar el parámetro normalize:
conv = GCNConv(in_channels, out_channels, normalize=True)  # Default
```

### 5.5. Consideraciones Adicionales para Desbalance de Clases

Además de la normalización de vecindarios, se recomienda aplicar **ponderación de clases** en la función de pérdida para el desbalance en la variable de supervivencia:

```python
# Calcular pesos inversamente proporcionales a frecuencia de clase
class_counts = torch.bincount(labels)
class_weights = 1.0 / class_counts.float()
class_weights = class_weights / class_weights.sum()  # Normalizar

# Aplicar en Cross Entropy
loss = F.cross_entropy(predictions, labels, weight=class_weights)
```

| Técnica | Problema que Resuelve |
|---------|----------------------|
| **Normalización Kipf & Welling** | Desbalance en *estructura del grafo* (nodos con muchos vecinos) |
| **Ponderación de Clases** | Desbalance en *etiquetas* (más empresas que sobreviven vs. no sobreviven) |
| **Stratified Sampling** | Desbalance en *batches* durante mini-batch training |